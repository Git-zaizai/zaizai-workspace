<!-- b.html (è§†é¢‘æ’­æ”¾ç«¯) -->
<!DOCTYPE html>
<html>
  <head>
    <title>è§†é¢‘æ’­æ”¾ç«¯ (B)</title>
  </head>
  <body>
    <video
      id="remoteVideo"
      autoplay
    ></video>

    <script>
      const video = document.querySelector('video')
      video.onerror = error => {
        console.log('ğŸš€ ~ error:', error)
      }
      /* æ­¥éª¤5ï¼šæ’­æ”¾ç«¯åˆå§‹åŒ– */
      const ws = new WebSocket('ws://localhost:7379') // è¿æ¥åˆ°æ¥æ”¶ç«¯ä¸“ç”¨ç«¯ç‚¹
      let pc

      const configuration = {
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
      }

      ws.onopen = () => {
        ws.send('client')
      }

      // WebSocket æ¶ˆæ¯å¤„ç†
      ws.onmessage = async message => {
        let data
        try {
          data = JSON.parse(message.data)
        } catch (error) {
          data = message.data
        }

        if (data.code === 'sender-offer') {
          /* æ­¥éª¤5.1ï¼šå¤„ç†æ¨é€ç«¯ offer */
          pc = new RTCPeerConnection(configuration)

          // å¤„ç†è¿œç¨‹æµ
          pc.ontrack = event => {
            document.querySelector('video').srcObject = event.streams[0]
          }

          // å¤„ç† ICE å€™é€‰
          pc.onicecandidate = ({ candidate }) => {
            console.log("ğŸš€ ~ candidate:", candidate)
            if (candidate) {
              ws.send(
                JSON.stringify({
                  route: 'receiver-candidate',
                  data: candidate.toJSON(),
                })
              )
            }
          }

          /* æ­¥éª¤5.2ï¼šåˆ›å»ºåº”ç­” */
          await pc.setRemoteDescription(new RTCSessionDescription(data.data))
          const answer = await pc.createAnswer()
          await pc.setLocalDescription(answer)
          ws.send(
            JSON.stringify({
              route: 'receiver-answer',
              data: pc.localDescription,
            })
          )
        }

        if (data.code === 'sender-candidate') {
          /* æ­¥éª¤7ï¼šå¤„ç†æ¨é€ç«¯å€™é€‰ */
          pc.addIceCandidate(new RTCIceCandidate(data.data))
        }
      }
    </script>
  </body>
</html>
